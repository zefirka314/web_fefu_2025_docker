{% extends "fefu_lab/base.html" %}

{% block title %}{{ title }}{% endblock %}
{% block heading %}{{ title }}{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-layout">
        <!-- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ –° –ò–ù–§–û–†–ú–ê–¶–ò–ï–ô -->
        <div class="profile-sidebar">
            <!-- –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï -->
            <div class="user-card card">
                <div class="user-avatar">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar-large">
                    {% else %}
                        <div class="avatar-default-large">
                            {{ user.first_name|first }}{{ user.last_name|first }}
                        </div>
                    {% endif %}
                </div>
                <div class="user-info">
                    <h2>{{ user.get_full_name }}</h2>
                    <div class="user-role">
                        <span class="badge badge-{{ user.profile.role|lower }}">
                            {{ user.profile.get_role_display }}
                        </span>
                    </div>
                    <p class="user-email">{{ user.email }}</p>
                    <p class="user-joined">–í —Å–∏—Å—Ç–µ–º–µ —Å: {{ user.date_joined|date:"d.m.Y" }}</p>
                </div>
            </div>

            <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –†–û–õ–Ø–ú -->
            <div class="stats-card card">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                {% if user.profile.role == 'STUDENT' and student %}
                    <div class="stat-item">
                        <span class="stat-label">–ö—É—Ä—Å–æ–≤ –∑–∞–ø–∏—Å–∞–Ω–æ:</span>
                        <span class="stat-value">{{ enrollments.count }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—Å–æ–≤:</span>
                        <span class="stat-value">{{ enrollments|length }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ –∫—É—Ä—Å–æ–≤:</span>
                        <span class="stat-value">{{ enrollments|length }}</span>
                    </div>
                {% elif user.profile.role == 'TEACHER' and instructor %}
                    <div class="stat-item">
                        <span class="stat-label">–ú–æ–∏ –∫—É—Ä—Å—ã:</span>
                        <span class="stat-value">{{ courses.count }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</span>
                        <span class="stat-value">
                            {% with total=0 %}
                                {% for course in courses %}
                                    {% widthratio course.enrolled_students_count 1 1 as count %}
                                    {{ count|add:total }}
                                {% endfor %}
                            {% endwith %}
                        </span>
                    </div>
                {% elif user.profile.role == 'ADMIN' %}
                    <div class="stat-item">
                        <span class="stat-label">–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞:</span>
                        <span class="stat-value">–ü–æ–ª–Ω—ã–π</span>
                    </div>
                {% endif %}
            </div>

            <!-- –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø -->
            <div class="actions-card card">
                <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <a href="{% url 'dashboard' %}" class="action-link">
                    üìä –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                </a>
                {% if user.profile.role == 'STUDENT' %}
                    <a href="{% url 'course_list' %}" class="action-link">
                        üìö –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å
                    </a>
                {% elif user.profile.role == 'TEACHER' %}
                    <a href="{% url 'teacher_dashboard' %}" class="action-link">
                        üë®‚Äçüè´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏
                    </a>
                {% elif user.profile.role == 'ADMIN' %}
                    <a href="{% url 'admin_dashboard' %}" class="action-link">
                        ‚öôÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                    </a>
                    <a href="/admin/" class="action-link">
                        üîß –ê–¥–º–∏–Ω–∫–∞ Django
                    </a>
                {% endif %}
                <a href="{% url 'logout' %}" class="action-link logout">
                    üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                </a>
            </div>
        </div>

        <!-- –û–°–ù–û–í–ù–û–ï –°–û–î–ï–†–ñ–ò–ú–û–ï -->
        <div class="profile-content">
            <!-- –°–û–û–ë–©–ï–ù–ò–Ø -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <!-- –§–û–†–ú–´ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø -->
            <div class="edit-forms">
                <!-- –§–û–†–ú–ê –û–°–ù–û–í–ù–´–• –î–ê–ù–ù–´–• -->
                <div class="form-section card">
                    <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="id_first_name">–ò–º—è</label>
                                {{ user_form.first_name }}
                                {% if user_form.first_name.errors %}
                                    <div class="field-error">
                                        {% for error in user_form.first_name.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="form-group">
                                <label for="id_last_name">–§–∞–º–∏–ª–∏—è</label>
                                {{ user_form.last_name }}
                                {% if user_form.last_name.errors %}
                                    <div class="field-error">
                                        {% for error in user_form.last_name.errors %}
                                            <span>{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="id_email">Email</label>
                            {{ user_form.email }}
                            {% if user_form.email.errors %}
                                <div class="field-error">
                                    {% for error in user_form.email.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                </div>

                <!-- –§–û–†–ú–ê –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –î–ê–ù–ù–´–• -->
                <div class="form-section card">
                    <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    
                    <div class="form-group">
                        <label for="id_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        {{ profile_form.phone }}
                        {% if profile_form.phone.errors %}
                            <div class="field-error">
                                {% for error in profile_form.phone.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="id_bio">–û —Å–µ–±–µ</label>
                        {{ profile_form.bio }}
                        {% if profile_form.bio.errors %}
                            <div class="field-error">
                                {% for error in profile_form.bio.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="id_avatar">–ê–≤–∞—Ç–∞—Ä</label>
                        {{ profile_form.avatar }}
                        {% if profile_form.avatar.errors %}
                            <div class="field-error">
                                {% for error in profile_form.avatar.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if user.profile.avatar %}
                            <div class="current-avatar">
                                <small>–¢–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä:</small>
                                <img src="{{ user.profile.avatar.url }}" alt="–¢–µ–∫—É—â–∏–π –∞–≤–∞—Ç–∞—Ä" class="avatar-preview">
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- –°–ü–ï–¶–ò–§–ò–ß–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ü–û –†–û–õ–Ø–ú -->
                {% if user.profile.role == 'STUDENT' and student %}
                <div class="form-section card">
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—É–¥–µ–Ω—Ç–µ</h3>
                    <div class="student-info">
                        <div class="info-item">
                            <strong>–§–∞–∫—É–ª—å—Ç–µ—Ç:</strong> {{ student.get_faculty_display_name }}
                        </div>
                        {% if student.birth_date %}
                        <div class="info-item">
                            <strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> {{ student.birth_date|date:"d.m.Y" }}
                        </div>
                        <div class="info-item">
                            <strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> {{ student.get_age }} –ª–µ—Ç
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> {{ student.created_at|date:"d.m.Y" }}
                        </div>
                    </div>
                </div>
                {% elif user.profile.role == 'TEACHER' and instructor %}
                <div class="form-section card">
                    <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ</h3>
                    <div class="teacher-info">
                        {% if instructor.specialization %}
                        <div class="info-item">
                            <strong>–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:</strong> {{ instructor.specialization }}
                        </div>
                        {% endif %}
                        {% if instructor.degree %}
                        <div class="info-item">
                            <strong>–£—á–µ–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å:</strong> {{ instructor.degree }}
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                            <span class="badge {% if instructor.is_active %}badge-active{% else %}badge-dropped{% endif %}">
                                {{ instructor.is_active|yesno:"–ê–∫—Ç–∏–≤–µ–Ω,–ù–µ–∞–∫—Ç–∏–≤–µ–Ω" }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- –ö–ù–û–ü–ö–ò –°–û–•–†–ê–ù–ï–ù–ò–Ø -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-lg">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                        –û—Ç–º–µ–Ω–∞
                    </a>
                </div>
                    </form>
            </div>

            <!-- –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–ï–ö–¶–ò–ò –ü–û –†–û–õ–Ø–ú -->
            {% if user.profile.role == 'STUDENT' and enrollments %}
            <div class="additional-section card">
                <h3>–ú–æ–∏ –∫—É—Ä—Å—ã</h3>
                <div class="enrollments-list">
                    {% for enrollment in enrollments %}
                    <div class="enrollment-item">
                        <div class="course-info">
                            <h4>
                                <a href="{% url 'course_detail' enrollment.course.slug %}">
                                    {{ enrollment.course.title }}
                                </a>
                            </h4>
                            <div class="enrollment-meta">
                                <span class="badge badge-{{ enrollment.status|lower }}">
                                    {{ enrollment.get_status_display }}
                                </span>
                                <span>–ó–∞–ø–∏—Å–∞–Ω: {{ enrollment.enrolled_at|date:"d.m.Y" }}</span>
                                {% if enrollment.completed_at %}
                                <span>–ó–∞–≤–µ—Ä—à–µ–Ω: {{ enrollment.completed_at|date:"d.m.Y" }}</span>
                                {% endif %}
                                {% if enrollment.grade %}
                                <span>–û—Ü–µ–Ω–∫–∞: {{ enrollment.grade }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% elif user.profile.role == 'TEACHER' and courses %}
            <div class="additional-section card">
                <h3>–ú–æ–∏ –∫—É—Ä—Å—ã</h3>
                <div class="courses-list">
                    {% for course in courses %}
                    <div class="course-item">
                        <div class="course-info">
                            <h4>
                                <a href="{% url 'course_detail' course.slug %}">
                                    {{ course.title }}
                                </a>
                            </h4>
                            <div class="course-meta">
                                <span>{{ course.enrolled_students_count }} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</span>
                                <span>{{ course.available_spots }} —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç</span>
                                <span>{{ course.get_level_display }}</span>
                            </div>
                        </div>
                        <div class="course-actions">
                            <a href="{% url 'teacher_course_management' course.slug %}" class="btn btn-sm">
                                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
